# BMP图片查看器 - 模块化版本

一个用于Linux嵌入式设备的BMP图片查看器，支持触摸屏和键盘控制。

## 功能特性

- 支持24位和32位BMP图片显示
- 触摸屏手势控制（滑动切换图片、点击区域控制）
- 键盘快捷键控制
- 两种显示模式：快速显示和逐行显示
- 可调节的刷新延迟
- 多线程架构，响应流畅

## 项目结构

```
bmp_viewer/
├── include/            # 头文件目录
│   ├── common.h       # 公共定义和结构
│   ├── bmp_handler.h  # BMP图像处理
│   ├── lcd_control.h  # LCD屏幕控制
│   ├── touch_handler.h # 触摸屏处理
│   ├── file_scanner.h # 文件扫描
│   └── user_interface.h # 用户界面
├── src/               # 源文件目录
│   ├── common.c       # 公共函数实现
│   ├── bmp_handler.c  # BMP图像处理实现
│   ├── lcd_control.c  # LCD控制实现
│   ├── touch_handler.c # 触摸屏处理实现
│   ├── file_scanner.c # 文件扫描实现
│   └── user_interface.c # 用户界面实现
├── main.c            # 主程序入口
├── Makefile          # 编译配置
└── README.md         # 项目说明
```

## 编译方法

### 使用Makefile编译

```bash
# 普通编译
make

# 调试版本
make debug

# 发布版本
make release

# 清理
make clean

# 安装到系统
sudo make install

# 显示版本信息
make version

# 生成文档
make docs
```

### 手动编译

```bash
gcc -Wall -Wextra -std=c99 -pthread -Iinclude \
    src/*.c main.c -o bmp_viewer -pthread -lm
```

## 使用方法

### 基本用法

```bash
# 扫描当前目录的BMP文件
./bmp_viewer

# 指定扫描目录
./bmp_viewer /path/to/images

# 使用指定配置文件
./bmp_viewer -c config.conf

# 指定触摸设备
./bmp_viewer -t /dev/input/event1

# 使用快速显示模式
./bmp_viewer -f

# 设置显示延迟
./bmp_viewer -d 10

# 禁用触摸功能
./bmp_viewer -n

# 显示帮助信息
./bmp_viewer -h

# 显示版本信息
./bmp_viewer -v
```

### 控制方式

#### 键盘控制
- `n/N` 或 `回车`: 下一张图片
- `p/P`: 上一张图片
- `+`: 增加刷新延迟（显示变慢）
- `-`: 减少刷新延迟（显示变快）
- `0-9`: 直接设置刷新速度（0最快，9最慢）
- `s/S`: 切换显示模式（快速/逐行）
- `r/R`: 重新加载当前图片
- `h/H`: 显示帮助信息
- `i/I`: 显示当前图片信息
- `d/D`: 切换调试模式
- `q/Q/ESC`: 退出程序

#### 触摸屏控制
- 点击左侧1/3区域: 上一张图片
- 点击右侧1/3区域: 下一张图片
- 左滑: 下一张图片
- 右滑: 上一张图片
- 上下滑: 切换显示模式

## 系统要求

- Linux操作系统
- 支持framebuffer的显示设备（/dev/fb0）
- 触摸屏设备（可选，通常为/dev/input/eventX）
- 支持pthread的C编译器

## 模块说明

### common.h/common.c
包含项目的公共定义、全局状态结构和工具函数。

### config.h/config.c
处理配置文件的读取、解析和保存。

### bmp_handler.h/bmp_handler.c  
处理BMP文件的读取、解析和显示功能。

### lcd_control.h/lcd_control.c
管理LCD屏幕的初始化、内存映射和清理操作。

### touch_handler.h/touch_handler.c
处理触摸屏事件的检测、解析和响应。

### file_scanner.h/file_scanner.c
扫描指定目录中的BMP文件。

### user_interface.h/user_interface.c
处理用户交互界面和键盘输入。

## 注意事项

1. 需要root权限访问/dev/fb0和触摸设备
2. 确保触摸设备路径正确（通常在/dev/input/目录下）
3. 支持的BMP格式：24位和32位，不支持压缩格式
4. 图片会按比例显示在屏幕中央

## 故障排除

### 编译错误
- 确保安装了gcc和pthread库
- 检查头文件路径是否正确

### 运行时错误
- 检查是否有足够的权限访问设备文件
- 确认framebuffer设备存在且可访问
- 验证触摸设备路径是否正确

### 性能问题
- 大图片可能显示较慢，可以调整刷新延迟
- 使用快速显示模式可以提高性能

## 开发说明

这个项目采用模块化设计，便于维护和扩展：

1. **低耦合**: 各模块职责明确，接口清晰
2. **易扩展**: 可以轻松添加新的图像格式支持
3. **可测试**: 每个模块都可以独立测试
4. **可移植**: 硬件相关代码集中在特定模块中

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

### 1. 点击屏幕控制
- **点击屏幕左侧1/3区域** → 显示上一张图片
- **点击屏幕右侧1/3区域** → 显示下一张图片
- **点击屏幕中间区域** → 当前无特殊功能

### 2. 滑动手势控制
- **左滑（向左滑动）** → 显示下一张图片
- **右滑（向右滑动）** → 显示上一张图片
- **上下滑动** → 切换刷新模式（逐行显示 ↔ 快速显示）

### 3. 键盘控制（保留原有功能）
- `n/N` 或 `回车` → 下一张图片
- `p/P` → 上一张图片
- `s/S` → 切换显示模式
- `r/R` → 重新加载当前图片
- `+` → 增加刷新延迟（显示变慢）
- `-` → 减少刷新延迟（显示变快）
- `0-9` → 直接设置刷新速度（0最快，9最慢）
- `q/Q/ESC` → 退出程序

## 技术实现细节

### 多线程设计
- 主线程：处理键盘输入和图片显示
- 触摸线程：处理触摸屏事件
- 使用互斥锁保证线程安全

### 触摸屏坐标映射
- 触摸屏坐标 → 屏幕坐标
- X轴：`current_x = event.value * 800 / 1024`
- Y轴：`current_y = event.value * 480 / 600`

### 手势识别逻辑
- **滑动判定**：移动距离超过100像素
- **点击判定**：移动距离小于100像素
- **方向判定**：比较水平和垂直移动距离

### 屏幕区域划分
```
|<--左侧区域-->|<--中间区域-->|<--右侧区域-->|
|   (上一张)   |   (无功能)   |   (下一张)   |
|     1/3      |     1/3      |     1/3      |
```

## 注意事项

1. **设备文件**：程序使用 `/dev/input/event0` 作为触摸屏设备
2. **屏幕设备**：程序使用 `/dev/fb0` 作为LCD显示设备
3. **图片格式**：只支持24位和32位的BMP格式图片
4. **运行权限**：可能需要root权限来访问设备文件

## 故障排除

### 触摸屏不响应
- 检查触摸屏设备文件是否存在：`ls -l /dev/input/event*`
- 确认程序有访问设备的权限
- 可能需要修改触摸屏设备文件路径

### 图片显示异常
- 确认BMP文件格式正确（24位或32位）
- 检查LCD设备文件：`ls -l /dev/fb0`
- 确认屏幕分辨率设置正确

### 编译错误
- 确保系统安装了pthread库
- 检查gcc编译器是否正常工作


##作者的话
- 这个项目是我在学习Linux嵌入式开发时的一个实践项目, 说实话写的挺垃圾
- 一堆功能没做, 比如图片缩放, 旋转, 触摸屏手势识别等
- 草草能运行了就丢上来了, 算法也很简单, 主要是为了练手
- 不过还是希望能对你有所帮助, 如果有任何问题欢迎提问